<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nostr IoT DVM Device: Nostriot Device</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Nostr IoT DVM Device<span id="projectnumber">&#160;v1.0.0</span>
   </div>
   <div id="projectbrief">An ESP32 based IoT device with Nostr DVM protocol support</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Nostriot Device </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> A Nostr IoT device implementing Data Vending Machine (DVM) services with Lightning Network payment integration.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Overview</h1>
<p>This is a hardware-based Nostr IoT device built for the ESP32-S3 Guition JC3248W535 touch screen display. The device implements the Nostr DVM (Data Vending Machine) protocol to provide IoT services like temperature readings and device control through the Nostr network, with optional Lightning Network payments for premium services.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Features</h1>
<ul>
<li><b>Nostr DVM Protocol</b>: Complete implementation of Data Vending Machine services</li>
<li><b>IoT Services</b>: Temperature monitoring, LED control, and extensible sensor integration</li>
<li><b>Lightning Payments</b>: LNbits integration for paid services with automatic payment processing</li>
<li><b>Touch Screen Interface</b>: 320x480 color touchscreen for device management</li>
<li><b>WiFi Connectivity</b>: Connect to Nostr relays and payment providers via WiFi</li>
<li><b>Payment Queue</b>: Robust payment processing with timeout management</li>
<li><b>Real-time Monitoring</b>: WebSocket-based payment confirmation and status updates</li>
<li><b>Modular Architecture</b>: Clean separation of concerns for easy maintenance and extension</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Hardware Requirements</h1>
<ul>
<li>ESP32-S3 dev board</li>
<li>Compatible sensors (temperature, etc.)</li>
<li>Power supply (USB or battery)</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Getting Started</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Prerequisites</h2>
<ul>
<li><a href="https://platformio.org/">PlatformIO</a> installed</li>
<li>ESP32-S3 development board</li>
<li>LNbits instance for Lightning payments</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Customising the IoT device for your hardware</h2>
<p>The <code><a class="el" href="nostriot__provider_8cpp.html">src/nostriot_provider.cpp</a></code> module lets you customise your Nostr IoT device to match your own hardware and pricing model. In <code><a class="el" href="nostriot__provider_8cpp.html">src/nostriot_provider.cpp</a></code> you define what the device can do (capabilities), and how much each action costs (in sats). The example includes an number of example methods with different pricing. This demonstrates how to set up free and variable paid services.</p>
<p>To adapt it, change the hardware configuration for your pins and sensors in the <code>init()</code> function, then add or edit entries in capabilities_with_pricing. Each capability’s behaviour is defined in the <code>run()</code> function, where you decide what happens when it’s called.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Building and Flashing</h2>
<div class="fragment"><div class="line"># Clone the repository</div>
<div class="line">git clone &lt;repository-url&gt;</div>
<div class="line">cd nostriot-device</div>
<div class="line"> </div>
<div class="line"># Build the project</div>
<div class="line">pio run</div>
<div class="line"> </div>
<div class="line"># Upload to device</div>
<div class="line">pio run --target upload</div>
<div class="line"> </div>
<div class="line"># Monitor serial output with exception decoder</div>
<div class="line">pio device monitor</div>
<div class="line"> </div>
<div class="line"># Build and upload with monitoring</div>
<div class="line">pio run --target upload --target monitor</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Documentation</h2>
<div class="fragment"><div class="line"># Generate documentation</div>
<div class="line">pio run -t docs</div>
<div class="line"> </div>
<div class="line"># Run code quality checks</div>
<div class="line">pio check</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
Initial Setup</h2>
<ol type="1">
<li><b>Configure</b> Wifi, Nostr, and LNbits settings in <code><a class="el" href="config_8h.html" title="System Configuration Constants and Definitions.">src/config.h</a></code></li>
<li><b>Flash</b> the firmware to the ESP32-S3 device using PlatformIO either using VSCode or command line</li>
</ol>
<ol type="1">
<li><b>Power on the device</b></li>
</ol>
<h2><a class="anchor" id="autotoc_md10"></a>
Usage</h2>
<p><b>IoT Service Requests:</b></p><ol type="1">
<li>Send DVM job requests (kind 5107) to the device's public key</li>
<li>Free services execute immediately</li>
<li>Paid services return payment requests with Lightning invoices</li>
<li>Pay the invoice to receive service response</li>
</ol>
<p><b>Available Services:</b></p><ul>
<li>The available services and their pricing can be configured in <code><a class="el" href="nostriot__provider_8cpp.html">src/nostriot_provider.cpp</a></code> this is where external sensors / actuators can be integrated.</li>
</ul>
<p><b>Payment Integration:</b></p><ul>
<li>Automatic Lightning invoice generation via LNbits</li>
<li>Real-time payment monitoring and confirmation</li>
<li>Payment queue with timeout management</li>
<li>Support for both BOLT11 invoices and Nostr zaps</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
Architecture</h1>
<p>The application uses a clean modular architecture:</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Core Modules</h2>
<ul>
<li><b><a class="el" href="namespace_app.html">App</a></b>: Central coordinator managing all modules and inter-module communication</li>
<li><b><a class="el" href="namespace_nostr_manager.html">NostrManager</a></b>: Nostr protocol implementation, DVM message handling, and relay communication</li>
<li><b><a class="el" href="namespace_payment_provider.html">PaymentProvider</a></b>: Lightning payment integration, invoice generation, and payment monitoring</li>
<li><b><a class="el" href="namespace_nostriot_provider.html">NostriotProvider</a></b>: IoT device capabilities, sensor reading, and device control</li>
<li><b>WiFiManager</b>: Network connectivity and configuration management</li>
<li><b><a class="el" href="namespace_display.html">Display</a></b>: Touch screen interface and status display</li>
<li><b><a class="el" href="namespace_settings.html">Settings</a></b>: Persistent configuration storage and management</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Key Features</h2>
<ul>
<li><b>Payment Queue</b>: Handles concurrent payment requests with proper timeout management</li>
<li><b>WebSocket Monitoring</b>: Real-time payment confirmations from LNbits</li>
<li><b>Modular Payment System</b>: Easy to swap payment providers (LNbits → other Lightning services)</li>
<li><b>DVM Protocol</b>: Complete implementation of Nostr Data Vending Machine specification</li>
<li><b>Event-Driven Architecture</b>: Clean separation between protocol handling and business logic</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Configuration</h1>
<p>Configuration options in <code><a class="el" href="config_8h.html" title="System Configuration Constants and Definitions.">src/config.h</a></code>:</p>
<div class="fragment"><div class="line"><span class="comment">// WiFi</span></div>
<div class="line"><span class="preprocessor">#define WIFI_SSID       &quot;[YOUR WIFI SSID]&quot;</span></div>
<div class="line"><span class="preprocessor">#define WIFI_PASSWORD   &quot;[YOUR WIFI PASSWORD]&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Nostr relay. relay.nostriot.com is a public relay run by the Nostriot project</span></div>
<div class="line"><span class="preprocessor">#define NOSTR_RELAY_URI &quot;wss://relay.nostriot.com&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Nostr private key in hex format (32 bytes, 64 hex characters).</span></div>
<div class="line"><span class="comment">// You can use https://nostrtool.com/ to generate a new key pair</span></div>
<div class="line"><span class="preprocessor">#define NOSTR_PRIVATE_KEY &quot;[YOUR NOSTR PRIVATE KEY IN HEX FORMAT]&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// This is the d tag value that is added to the replacable DVM advert</span></div>
<div class="line"><span class="comment">// You probably don&#39;t need to change this unless you run multiple devices with the same private key</span></div>
<div class="line"><span class="preprocessor">#define DVM_ADVERTISEMENT_EVENT_D_TAG_VALUE &quot;dvm-advert-1&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// LNbits configuration for Lightning payments</span></div>
<div class="line"><span class="preprocessor">#define LNBITS_HOST_URL &quot;[YOUR LNBITS HOST URL WITHOUT https:// e.g. demo.lnbits.com]&quot;</span></div>
<div class="line"><span class="preprocessor">#define LNBITS_INVOICE_KEY &quot;[YOUR LNBITS INVOICE KEY]&quot;</span></div>
<div class="line"><span class="preprocessor">#define LNBITS_PAYMENTS_ENDPOINT &quot;/api/v1/payments&quot;</span> <span class="comment">// usually don&#39;t change this</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
Code Quality</h2>
<div class="fragment"><div class="line"># Run code quality checks</div>
<div class="line">pio check</div>
<div class="line"> </div>
<div class="line"># Find unused functions</div>
<div class="line">cppcheck --enable=unusedFunction src/</div>
<div class="line"> </div>
<div class="line"># Wider analysis</div>
<div class="line">cppcheck --enable=unusedFunction,style --inconclusive src/</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md16"></a>
License</h1>
<p>MIT License </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
